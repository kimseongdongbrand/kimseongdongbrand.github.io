<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š ë¹„ì¦ˆë‹ˆìŠ¤ ì¸í…”ë¦¬ì „ìŠ¤ ëŒ€ì‹œë³´ë“œ v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #0f0f23;
            min-height: 100vh;
            color: #fff;
        }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px;
            border-right: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            overflow-y: auto;
        }
        .logo {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0,174,239,0.1);
            border-radius: 12px;
        }
        .nav-section {
            margin-bottom: 20px;
        }
        .nav-section-title {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-left: 10px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.3s;
            color: #888;
            font-size: 14px;
            text-decoration: none;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(0,174,239,0.2);
            color: #00AEEF;
        }
        .nav-item.active {
            border-left: 3px solid #00AEEF;
            background: rgba(0,174,239,0.15);
        }
        
        /* ë©”ì¸ ì½˜í…ì¸  */
        .main {
            margin-left: 260px;
            padding: 30px;
            min-height: 100vh;
        }
        
        /* í—¤ë” */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        .header-subtitle {
            color: #888;
            margin-top: 5px;
            font-size: 14px;
        }
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .period-selector {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        .period-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        .period-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .period-btn.active {
            background: #00AEEF;
            color: white;
        }
        .refresh-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .refresh-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .refresh-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* ì‹œìŠ¤í…œ ìƒíƒœ */
        .system-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
        }
        .system-status.healthy {
            background: rgba(0,255,136,0.1);
            border: 1px solid rgba(0,255,136,0.3);
            color: #00ff88;
        }
        .system-status.error {
            background: rgba(255,107,107,0.1);
            border: 1px solid rgba(255,107,107,0.3);
            color: #ff6b6b;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .system-status.healthy .status-dot { background: #00ff88; }
        .system-status.error .status-dot { background: #ff6b6b; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* KPI ì¹´ë“œ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        .kpi-card.revenue::before { background: linear-gradient(180deg, #00AEEF, #0088CC); }
        .kpi-card.bookings::before { background: linear-gradient(180deg, #00ff88, #00cc66); }
        .kpi-card.growth::before { background: linear-gradient(180deg, #ff6b6b, #ee5a5a); }
        .kpi-card.performance::before { background: linear-gradient(180deg, #ffd93d, #ffb800); }
        
        .kpi-icon {
            font-size: 24px;
            margin-bottom: 12px;
        }
        .kpi-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .kpi-value {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
        }
        .kpi-card.revenue .kpi-value { color: #00AEEF; }
        .kpi-card.bookings .kpi-value { color: #00ff88; }
        .kpi-card.growth .kpi-value { color: #ff6b6b; }
        .kpi-card.performance .kpi-value { color: #ffd93d; }
        
        .kpi-change {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        .kpi-change.positive { color: #00ff88; }
        .kpi-change.negative { color: #ff6b6b; }
        .kpi-change.neutral { color: #888; }
        
        /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .chart-title {
            font-size: 16px;
            font-weight: 700;
        }
        .chart-legend {
            display: flex;
            gap: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #888;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .chart-container {
            height: 280px;
            position: relative;
        }
        
        /* í•˜ë‹¨ ê·¸ë¦¬ë“œ */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* í…Œì´ë¸” */
        .table-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            text-align: left;
            padding: 12px;
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
        }
        .data-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-badge.up { background: rgba(0,255,136,0.2); color: #00ff88; }
        .status-badge.down { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .status-badge.stable { background: rgba(255,217,61,0.2); color: #ffd93d; }
        .status-badge.pending { background: rgba(136,136,136,0.2); color: #888; }
        
        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            background: rgba(255,107,107,0.1);
            border: 1px solid rgba(255,107,107,0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #ff6b6b;
        }
        .error-message h3 {
            margin-bottom: 10px;
        }
        
        /* ë¡œë”© */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15,15,35,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay.hidden {
            display: none;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #00AEEF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* ì„¤ì • ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.hidden {
            display: none;
        }
        .modal {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal h2 {
            margin-bottom: 20px;
        }
        .modal-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .modal-input:focus {
            outline: none;
            border-color: #00AEEF;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-btn.primary {
            background: #00AEEF;
            color: white;
        }
        .modal-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        /* í‘¸í„° */
        .footer {
            text-align: center;
            color: #666;
            font-size: 12px;
            padding: 20px;
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 1400px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-grid { grid-template-columns: 1fr; }
            .bottom-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 900px) {
            .sidebar { 
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main { margin-left: 0; }
            .bottom-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>
    
    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal-overlay hidden" id="settingsModal">
        <div class="modal">
            <h2>âš™ï¸ API ì„¤ì •</h2>
            <p style="color: #888; margin-bottom: 15px;">Google Apps Script ë°°í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" class="modal-input" id="apiUrlInput" 
                   placeholder="https://script.google.com/macros/s/...">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeSettings()">ì·¨ì†Œ</button>
                <button class="modal-btn primary" onclick="saveSettings()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <span>ğŸ”§</span>
            <span>í™ˆì¼€ì–´ ê¹¨ë—í•œì§‘</span>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">ë¶„ì„</div>
            <a href="analytics.html" class="nav-item active">
                <span>ğŸ“Š</span>
                <span>BI ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a href="monitoring.html" class="nav-item">
                <span>ğŸ¥</span>
                <span>ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§</span>
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">ê´€ë¦¬</div>
            <a href="admin.html" class="nav-item">
                <span>ğŸ“‹</span>
                <span>ì˜ˆì•½ ê´€ë¦¬</span>
            </a>
            <a href="manager.html" class="nav-item">
                <span>ğŸ‘¥</span>
                <span>ë§¤ë‹ˆì € ì•±</span>
            </a>
            <a href="index.html" class="nav-item">
                <span>ğŸ </span>
                <span>ê³ ê° ì˜ˆì•½</span>
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">ì„¤ì •</div>
            <a href="#" class="nav-item" onclick="openSettings(); return false;">
                <span>âš™ï¸</span>
                <span>API ì„¤ì •</span>
            </a>
        </div>
        
        <div style="position: absolute; bottom: 20px; left: 20px; right: 20px;">
            <div style="font-size: 11px; color: #666;">
                ë²„ì „ 2.4 Enterprise<br>
                ì—°ë™ ìƒíƒœ: <span id="connectionStatus" style="color: #00ff88;">í™•ì¸ ì¤‘...</span>
            </div>
        </div>
    </div>
    
    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main">
        <!-- í—¤ë” -->
        <div class="header">
            <div>
                <h1>ğŸ“Š ë¹„ì¦ˆë‹ˆìŠ¤ ì¸í…”ë¦¬ì „ìŠ¤</h1>
                <p class="header-subtitle">ì‹¤ì‹œê°„ ë§¤ì¶œ ë° ì˜ˆì•½ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</p>
            </div>
            <div class="header-controls">
                <div class="system-status healthy" id="systemStatus">
                    <div class="status-dot"></div>
                    <span id="systemStatusText">ì—°ê²°ë¨</span>
                </div>
                <div class="period-selector">
                    <button class="period-btn" data-period="week" onclick="setPeriod(this, 'week')">ì£¼ê°„</button>
                    <button class="period-btn active" data-period="month" onclick="setPeriod(this, 'month')">ì›”ê°„</button>
                    <button class="period-btn" data-period="quarter" onclick="setPeriod(this, 'quarter')">ë¶„ê¸°</button>
                    <button class="period-btn" data-period="year" onclick="setPeriod(this, 'year')">ì—°ê°„</button>
                </div>
                <button class="refresh-btn" onclick="refreshAll()" id="refreshBtn">
                    <span>ğŸ”„</span>
                    <span>ìƒˆë¡œê³ ì¹¨</span>
                </button>
            </div>
        </div>
        
        <!-- KPI ì¹´ë“œ -->
        <div class="kpi-grid">
            <div class="kpi-card revenue">
                <div class="kpi-icon">ğŸ’°</div>
                <div class="kpi-label">ì´ ë§¤ì¶œ</div>
                <div class="kpi-value" id="totalRevenue">â‚©0</div>
                <div class="kpi-change neutral" id="revenueChange">
                    <span>-</span>
                    <span>ì´ì „ ê¸°ê°„ ëŒ€ë¹„</span>
                </div>
            </div>
            <div class="kpi-card bookings">
                <div class="kpi-icon">ğŸ“…</div>
                <div class="kpi-label">ì´ ì˜ˆì•½</div>
                <div class="kpi-value" id="totalBookings">0ê±´</div>
                <div class="kpi-change neutral" id="bookingsChange">
                    <span>-</span>
                    <span>ì´ì „ ê¸°ê°„ ëŒ€ë¹„</span>
                </div>
            </div>
            <div class="kpi-card growth">
                <div class="kpi-icon">ğŸ’µ</div>
                <div class="kpi-label">í‰ê·  ê°ë‹¨ê°€</div>
                <div class="kpi-value" id="avgRevenue">â‚©0</div>
                <div class="kpi-change neutral" id="avgChange">
                    <span>-</span>
                    <span>ì´ì „ ê¸°ê°„ ëŒ€ë¹„</span>
                </div>
            </div>
            <div class="kpi-card performance">
                <div class="kpi-icon">âœ…</div>
                <div class="kpi-label">ì™„ë£Œìœ¨</div>
                <div class="kpi-value" id="completionRate">0%</div>
                <div class="kpi-change neutral" id="completionChange">
                    <span>-</span>
                    <span>ì´ì „ ê¸°ê°„ ëŒ€ë¹„</span>
                </div>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì°¨íŠ¸ -->
        <div class="chart-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">ğŸ“ˆ ë§¤ì¶œ & ì˜ˆì•½ ì¶”ì´</div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #00AEEF;"></div>
                            <span>ë§¤ì¶œ (ë§Œì›)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #00ff88;"></div>
                            <span>ì˜ˆì•½ ê±´ìˆ˜</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">ğŸ˜ï¸ ì•„íŒŒíŠ¸ë³„ ë§¤ì¶œ</div>
                </div>
                <div class="chart-container">
                    <canvas id="apartmentChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- í•˜ë‹¨ ì°¨íŠ¸ -->
        <div class="bottom-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">ğŸ”§ ì„œë¹„ìŠ¤ ìœ í˜•ë³„</div>
                </div>
                <div class="chart-container">
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">ğŸ‘¥ ë§¤ë‹ˆì €ë³„ ì‹¤ì </div>
                </div>
                <div class="chart-container">
                    <canvas id="managerChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">ğŸ“… ìš”ì¼ë³„ ì˜ˆì•½</div>
                </div>
                <div class="chart-container">
                    <canvas id="weekdayChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ìµœê·¼ ì˜ˆì•½ í…Œì´ë¸” -->
        <div class="table-card">
            <div class="chart-header">
                <div class="chart-title">ğŸ“‹ ìµœê·¼ ì˜ˆì•½ í˜„í™©</div>
                <a href="admin.html" class="refresh-btn" style="padding: 8px 16px; font-size: 13px; text-decoration: none;">
                    ì „ì²´ë³´ê¸° â†’
                </a>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ì˜ˆì•½ë²ˆí˜¸</th>
                        <th>ê³ ê°ëª…</th>
                        <th>ì•„íŒŒíŠ¸</th>
                        <th>ì„œë¹„ìŠ¤</th>
                        <th>ë‚ ì§œ</th>
                        <th>ë§¤ì¶œ</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="recentBookingsTable">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #888;">
                            ë°ì´í„° ë¡œë”© ì¤‘...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- í‘¸í„° -->
        <div class="footer">
            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span> | 
            ìë™ ìƒˆë¡œê³ ì¹¨: 60ì´ˆ | 
            ë°ì´í„° ì†ŒìŠ¤: Google Sheets
        </div>
    </div>
    
    <script>
        // ============================================
        // ì „ì—­ ì„¤ì •
        // ============================================
        
        // â­ ë§¤ë‹ˆì €í˜ì´ ì œì™¸ ëŒ€ìƒ (í˜ì´ 0ì›)
        const EXCLUDED_WORKERS = ['ì†¡ëŒ€í—Œ', 'ê°„ìµì¤€', 'ê¹€ì„±ë™', 'ê¹€ì˜ë°°', 'ìœ í•˜ëŠ˜', 'ì‹¬ì¬ì¤€'];
        
        // â­ í˜ì´ ì œì™¸ ëŒ€ìƒì¸ì§€ ì²´í¬
        function isExcludedWorker(name) {
            if (!name) return false;
            return EXCLUDED_WORKERS.includes(String(name).trim());
        }
        
        // â­ ë§¤ë‹ˆì €í˜ì´ ê³„ì‚° (ì œì™¸ ëŒ€ìƒ ë°˜ì˜)
        function calculateManagerPayForStats(booking) {
            const service = booking.service || booking.items || '';
            const assignType = booking.assignType || 'í˜¼ì';
            const managerName = booking.manager || '';
            const subManagerName = booking.subManager || '';
            
            let totalPay = 0;
            const isBoth = service.includes('ë‚œë°©') && service.includes('ìˆ˜ë„');
            
            // ì • ë§¤ë‹ˆì € í˜ì´
            if (managerName && !isExcludedWorker(managerName)) {
                if (isBoth) {
                    totalPay += (assignType === 'í˜¼ì') ? 110000 : 80000;
                } else if (service.includes('ë‚œë°©')) {
                    totalPay += 80000;
                } else if (service.includes('ìˆ˜ë„')) {
                    totalPay += 50000;
                }
            }
            
            // ë¶€ ë§¤ë‹ˆì € í˜ì´
            if (subManagerName && !isExcludedWorker(subManagerName) && isBoth && assignType === 'ì •+ë¶€') {
                totalPay += 50000;
            }
            
            return totalPay;
        }
        
        // â­ fetch íƒ€ì„ì•„ì›ƒ ë˜í¼ (30ì´ˆ)
        async function fetchWithTimeout(url, options = {}, timeout = 30000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)');
                }
                throw error;
            }
        }
        
        // âš ï¸ ì—¬ê¸°ì— Google Apps Script ë°°í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”!
        // ëª¨ë“  5ê°œ íˆ´ì´ ì´ URLì„ ê³µìœ í•©ë‹ˆë‹¤.
        let GOOGLE_SCRIPT_URL = localStorage.getItem('HOMECARE_API_URL') || 
            'https://script.google.com/macros/s/AKfycbxRKOfqpoMwV_PGWFOt-O32i1cz9ZKH9SJutoJ9q8au6GwBQ72PyY7aEtVOrSawltBLBA/exec';
        
        let currentPeriod = 'month';
        let charts = {};
        let allBookingsData = [];
        let isLoading = false;
        let lastFetchTime = null;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        
        // ì°¨íŠ¸ ê¸°ë³¸ ì„¤ì •
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, sans-serif';
        
        // ============================================
        // ì„¤ì • ê´€ë¦¬
        // ============================================
        
        function openSettings() {
            document.getElementById('apiUrlInput').value = GOOGLE_SCRIPT_URL;
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }
        
        function saveSettings() {
            const newUrl = document.getElementById('apiUrlInput').value.trim();
            if (newUrl && newUrl.startsWith('https://script.google.com/')) {
                GOOGLE_SCRIPT_URL = newUrl;
                localStorage.setItem('HOMECARE_API_URL', newUrl);
                closeSettings();
                refreshAll();
                showNotification('API URLì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showNotification('ì˜¬ë°”ë¥¸ Google Apps Script URLì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
            }
        }
        
        function showNotification(message, type) {
            // ê°„ë‹¨í•œ ì•Œë¦¼ (ì¶”í›„ í† ìŠ¤íŠ¸ë¡œ ë³€ê²½ ê°€ëŠ¥)
            if (type === 'error') {
                alert('âŒ ' + message);
            }
        }
        
        // ============================================
        // ê¸°ê°„ ì„¤ì •
        // ============================================
        
        function setPeriod(button, period) {
            currentPeriod = period;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            // ë°ì´í„° ë‹¤ì‹œ ë Œë”ë§
            if (allBookingsData.length > 0) {
                renderAllData(allBookingsData);
            }
        }
        
        // ============================================
        // ì‹œìŠ¤í…œ ìƒíƒœ
        // ============================================
        
        function updateSystemStatus(status, message) {
            const statusEl = document.getElementById('systemStatus');
            const statusText = document.getElementById('systemStatusText');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (status === 'healthy') {
                statusEl.className = 'system-status healthy';
                statusText.textContent = message || 'ì—°ê²°ë¨';
                connectionStatus.textContent = 'ì—°ê²°ë¨';
                connectionStatus.style.color = '#00ff88';
            } else {
                statusEl.className = 'system-status error';
                statusText.textContent = message || 'ì—°ê²° ì˜¤ë¥˜';
                connectionStatus.textContent = 'ì—°ê²° ëŠê¹€';
                connectionStatus.style.color = '#ff6b6b';
            }
        }
        
        // ============================================
        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        // ============================================
        
        async function fetchBookings() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ì´ˆ íƒ€ì„ì•„ì›ƒ
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getBookings`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && Array.isArray(data.bookings)) {
                    allBookingsData = data.bookings;
                    lastFetchTime = new Date();
                    retryCount = 0;
                    updateSystemStatus('healthy', 'ì—°ê²°ë¨');
                    return data.bookings;
                } else {
                    throw new Error(data.message || 'ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                }
                
            } catch (error) {
                
                
                if (error.name === 'AbortError') {
                    updateSystemStatus('error', 'íƒ€ì„ì•„ì›ƒ');
                } else {
                    updateSystemStatus('error', 'ì—°ê²° ì˜¤ë¥˜');
                }
                
                // ì¬ì‹œë„
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    
                    await new Promise(r => setTimeout(r, 2000));
                    return fetchBookings();
                }
                
                // ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš© (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)
                
                allBookingsData = generateSampleData();
                return allBookingsData;
            }
        }
        
        // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        function generateSampleData() {
            const apartments = ['ë˜ë¯¸ì•ˆ íŒŒí¬ìŠ¤ìœ„íŠ¸', 'ìì´ ì•„íŒŒíŠ¸', 'íìŠ¤í…Œì´íŠ¸', 'í‘¸ë¥´ì§€ì˜¤', 'ë¡¯ë°ìºìŠ¬', 'eí¸í•œì„¸ìƒ'];
            const services = ['30í‰í˜• / ë‚œë°©ê´€ ìŠ¤ì¼€ì¼ë§', '40í‰í˜• / ìˆ˜ë„ê´€ ìŠ¤ì¼€ì¼ë§', '50í‰í˜• / ë‚œë°©ê´€+ìˆ˜ë„ê´€'];
            const managers = ['ë°•ê¸°ì‚¬', 'ê¹€ê¸°ì‚¬', 'ì´ê¸°ì‚¬', 'ìµœê¸°ì‚¬', 'ì •ê¸°ì‚¬'];
            const statuses = ['ì™„ë£Œ', 'í™•ì •', 'ì ‘ìˆ˜', 'ì…ê¸ˆ'];
            
            const data = [];
            const today = new Date();
            
            for (let i = 0; i < 150; i++) {
                const daysAgo = Math.floor(Math.random() * 400);
                const date = new Date(today);
                date.setDate(date.getDate() - daysAgo);
                
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                data.push({
                    number: 10000 + i,
                    name: `í™ê¸¸ë™${i + 1}`,
                    phone: `010-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
                    apartment: apartments[Math.floor(Math.random() * apartments.length)],
                    dong: `${Math.floor(Math.random() * 20) + 100}`,
                    ho: `${Math.floor(Math.random() * 20) + 1}01`,
                    items: services[Math.floor(Math.random() * services.length)],
                    serviceDate: date.toISOString().split('T')[0],
                    revenue: (Math.floor(Math.random() * 5) + 1) * 50000 + 100000,
                    status: status,
                    manager: status === 'ì™„ë£Œ' || status === 'í™•ì •' ? managers[Math.floor(Math.random() * managers.length)] : ''
                });
            }
            
            return data.sort((a, b) => new Date(b.serviceDate) - new Date(a.serviceDate));
        }
        
        // ============================================
        // ê¸°ê°„ë³„ í•„í„°ë§
        // ============================================
        
        function filterByPeriod(data, period) {
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            let startDate = new Date(today);
            
            switch (period) {
                case 'week':
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case 'quarter':
                    startDate.setMonth(today.getMonth() - 3);
                    break;
                case 'year':
                    startDate.setFullYear(today.getFullYear() - 1);
                    break;
                default:
                    startDate.setMonth(today.getMonth() - 1);
            }
            
            startDate.setHours(0, 0, 0, 0);
            
            return data.filter(item => {
                const itemDate = new Date(item.serviceDate);
                return itemDate >= startDate && itemDate <= today;
            });
        }
        
        // ì´ì „ ê¸°ê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¹„êµìš©)
        function getPreviousPeriodData(data, period) {
            const today = new Date();
            let periodLength, startDate, endDate;
            
            switch (period) {
                case 'week':
                    periodLength = 7;
                    break;
                case 'month':
                    periodLength = 30;
                    break;
                case 'quarter':
                    periodLength = 90;
                    break;
                case 'year':
                    periodLength = 365;
                    break;
                default:
                    periodLength = 30;
            }
            
            endDate = new Date(today);
            endDate.setDate(today.getDate() - periodLength);
            endDate.setHours(23, 59, 59, 999);
            
            startDate = new Date(endDate);
            startDate.setDate(endDate.getDate() - periodLength);
            startDate.setHours(0, 0, 0, 0);
            
            return data.filter(item => {
                const itemDate = new Date(item.serviceDate);
                return itemDate >= startDate && itemDate <= endDate;
            });
        }
        
        // ============================================
        // KPI ì—…ë°ì´íŠ¸
        // ============================================
        
        function updateKPIs(data) {
            const filtered = filterByPeriod(data, currentPeriod);
            const previous = getPreviousPeriodData(data, currentPeriod);
            
            // ì´ ë§¤ì¶œ
            const totalRevenue = filtered.reduce((sum, b) => sum + (Number(b.revenue) || 0), 0);
            const prevRevenue = previous.reduce((sum, b) => sum + (Number(b.revenue) || 0), 0);
            document.getElementById('totalRevenue').textContent = 'â‚©' + totalRevenue.toLocaleString();
            
            // ì´ ì˜ˆì•½
            const totalBookings = filtered.length;
            const prevBookings = previous.length;
            document.getElementById('totalBookings').textContent = totalBookings + 'ê±´';
            
            // í‰ê·  ê°ë‹¨ê°€
            const avgRevenue = totalBookings > 0 ? Math.round(totalRevenue / totalBookings) : 0;
            const prevAvg = prevBookings > 0 ? Math.round(prevRevenue / prevBookings) : 0;
            document.getElementById('avgRevenue').textContent = 'â‚©' + avgRevenue.toLocaleString();
            
            // ì™„ë£Œìœ¨
            const completed = filtered.filter(b => 
                b.status === 'ì™„ë£Œ' || b.status === 'completed' || 
                b.status === 'ì…ê¸ˆ' || b.status === 'paid'
            ).length;
            const prevCompleted = previous.filter(b => 
                b.status === 'ì™„ë£Œ' || b.status === 'completed' || 
                b.status === 'ì…ê¸ˆ' || b.status === 'paid'
            ).length;
            const completionRate = totalBookings > 0 ? Math.round((completed / totalBookings) * 100) : 0;
            const prevCompletionRate = prevBookings > 0 ? Math.round((prevCompleted / prevBookings) * 100) : 0;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
            // ë³€í™”ìœ¨ ê³„ì‚°
            updateChangeIndicator('revenueChange', prevRevenue > 0 ? ((totalRevenue - prevRevenue) / prevRevenue) * 100 : 0);
            updateChangeIndicator('bookingsChange', prevBookings > 0 ? ((totalBookings - prevBookings) / prevBookings) * 100 : 0);
            updateChangeIndicator('avgChange', prevAvg > 0 ? ((avgRevenue - prevAvg) / prevAvg) * 100 : 0);
            updateChangeIndicator('completionChange', completionRate - prevCompletionRate);
        }
        
        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const isPositive = change > 0;
            const isNeutral = Math.abs(change) < 0.1;
            
            let className = 'kpi-change ';
            if (isNeutral) {
                className += 'neutral';
            } else {
                className += isPositive ? 'positive' : 'negative';
            }
            
            element.className = className;
            element.innerHTML = `
                <span>${isNeutral ? 'âˆ’' : (isPositive ? 'â†‘' : 'â†“')}</span>
                <span>${isPositive ? '+' : ''}${change.toFixed(1)}% ì´ì „ ê¸°ê°„ ëŒ€ë¹„</span>
            `;
        }
        
        // ============================================
        // ì°¨íŠ¸ ìƒì„±
        // ============================================
        
        function createRevenueChart(data) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            const filtered = filterByPeriod(data, currentPeriod);
            const grouped = {};
            
            filtered.forEach(item => {
                let key;
                if (currentPeriod === 'week') {
                    key = item.serviceDate;
                } else if (currentPeriod === 'year') {
                    key = item.serviceDate.substring(0, 7); // YYYY-MM
                } else {
                    key = item.serviceDate;
                }
                
                if (!grouped[key]) {
                    grouped[key] = { revenue: 0, count: 0 };
                }
                grouped[key].revenue += Number(item.revenue) || 0;
                grouped[key].count += 1;
            });
            
            const sortedKeys = Object.keys(grouped).sort();
            const displayKeys = currentPeriod === 'year' ? sortedKeys.slice(-12) : 
                               currentPeriod === 'quarter' ? sortedKeys.slice(-90) :
                               currentPeriod === 'month' ? sortedKeys.slice(-30) : sortedKeys;
            
            const labels = [];
            const revenueData = [];
            const bookingsData = [];
            
            displayKeys.forEach(key => {
                // ë ˆì´ë¸” í¬ë§·íŒ…
                if (currentPeriod === 'year') {
                    const [y, m] = key.split('-');
                    labels.push(`${m}ì›”`);
                } else {
                    const parts = key.split('-');
                    labels.push(`${parts[1]}/${parts[2]}`);
                }
                revenueData.push(Math.round(grouped[key].revenue / 10000)); // ë§Œì› ë‹¨ìœ„
                bookingsData.push(grouped[key].count);
            });
            
            if (charts.revenue) charts.revenue.destroy();
            
            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ë§¤ì¶œ (ë§Œì›)',
                            data: revenueData,
                            borderColor: '#00AEEF',
                            backgroundColor: 'rgba(0,174,239,0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointRadius: currentPeriod === 'week' ? 4 : 2,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'ì˜ˆì•½ ê±´ìˆ˜',
                            data: bookingsData,
                            borderColor: '#00ff88',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4,
                            yAxisID: 'y1',
                            pointRadius: currentPeriod === 'week' ? 4 : 2,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26,26,46,0.95)',
                            titleColor: '#fff',
                            bodyColor: '#888',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `ë§¤ì¶œ: ${context.parsed.y.toLocaleString()}ë§Œì›`;
                                    } else {
                                        return `ì˜ˆì•½: ${context.parsed.y}ê±´`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'ë§¤ì¶œ (ë§Œì›)', color: '#00AEEF' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'ì˜ˆì•½ ê±´ìˆ˜', color: '#00ff88' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        function createApartmentChart(data) {
            const ctx = document.getElementById('apartmentChart');
            if (!ctx) return;
            
            const filtered = filterByPeriod(data, currentPeriod);
            const grouped = {};
            
            filtered.forEach(item => {
                let apt = item.apartment || 'ê¸°íƒ€';
                // ì•„íŒŒíŠ¸ ì´ë¦„ ê°„ì†Œí™”
                apt = apt.replace(/\s*(ì•„íŒŒíŠ¸|ë‹¨ì§€|íƒ€ì›Œ).*$/g, '').substring(0, 10);
                if (!grouped[apt]) grouped[apt] = 0;
                grouped[apt] += Number(item.revenue) || 0;
            });
            
            const sorted = Object.entries(grouped)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            if (charts.apartment) charts.apartment.destroy();
            
            charts.apartment = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: [
                            '#00AEEF', '#00ff88', '#ff6b6b', 
                            '#ffd93d', '#a855f7', '#ec4899'
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { 
                                boxWidth: 12, 
                                padding: 12,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = Math.round((context.raw / total) * 100);
                                    return `${context.label}: â‚©${(context.raw / 10000).toFixed(0)}ë§Œì› (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createServiceChart(data) {
            const ctx = document.getElementById('serviceChart');
            if (!ctx) return;
            
            const filtered = filterByPeriod(data, currentPeriod);
            const grouped = { 'ë‚œë°©ê´€': 0, 'ìˆ˜ë„ê´€': 0, 'ì–‘ìª½': 0, 'ê¸°íƒ€': 0 };
            
            filtered.forEach(item => {
                const items = (item.items || '').toLowerCase();
                if ((items.includes('ë‚œë°©') && items.includes('ìˆ˜ë„')) || items.includes('+')) {
                    grouped['ì–‘ìª½'] += 1;
                } else if (items.includes('ë‚œë°©')) {
                    grouped['ë‚œë°©ê´€'] += 1;
                } else if (items.includes('ìˆ˜ë„')) {
                    grouped['ìˆ˜ë„ê´€'] += 1;
                } else {
                    grouped['ê¸°íƒ€'] += 1;
                }
            });
            
            if (charts.service) charts.service.destroy();
            
            charts.service = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: Object.keys(grouped),
                    datasets: [{
                        data: Object.values(grouped),
                        backgroundColor: [
                            'rgba(255,107,107,0.7)',
                            'rgba(0,174,239,0.7)',
                            'rgba(0,255,136,0.7)',
                            'rgba(136,136,136,0.5)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 11 } }
                        }
                    },
                    scales: {
                        r: {
                            ticks: { display: false },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        function createManagerChart(data) {
            const ctx = document.getElementById('managerChart');
            if (!ctx) return;
            
            const filtered = filterByPeriod(data, currentPeriod);
            const grouped = {};
            
            filtered.forEach(item => {
                const mgr = item.manager || 'ë¯¸ë°°ì •';
                if (mgr && mgr !== 'ë¯¸ë°°ì •' && mgr.trim() !== '') {
                    if (!grouped[mgr]) grouped[mgr] = { count: 0, revenue: 0 };
                    grouped[mgr].count += 1;
                    grouped[mgr].revenue += Number(item.revenue) || 0;
                }
            });
            
            const sorted = Object.entries(grouped)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            if (charts.manager) charts.manager.destroy();
            
            if (sorted.length === 0) {
                // ë°ì´í„° ì—†ìŒ í‘œì‹œ
                charts.manager = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['ë°ì´í„° ì—†ìŒ'],
                        datasets: [{ data: [0], backgroundColor: 'rgba(136,136,136,0.3)' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } }
                    }
                });
                return;
            }
            
            charts.manager = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'ë§¤ì¶œ (ë§Œì›)',
                        data: sorted.map(s => Math.round(s[1].revenue / 10000)),
                        backgroundColor: [
                            'rgba(0,174,239,0.8)',
                            'rgba(0,174,239,0.65)',
                            'rgba(0,174,239,0.5)',
                            'rgba(0,174,239,0.35)',
                            'rgba(0,174,239,0.2)'
                        ],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    return `ê±´ìˆ˜: ${sorted[idx][1].count}ê±´`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            title: { display: true, text: 'ë§¤ì¶œ (ë§Œì›)' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function createWeekdayChart(data) {
            const ctx = document.getElementById('weekdayChart');
            if (!ctx) return;
            
            const filtered = filterByPeriod(data, currentPeriod);
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const counts = [0, 0, 0, 0, 0, 0, 0];
            
            filtered.forEach(item => {
                if (item.serviceDate) {
                    const date = new Date(item.serviceDate);
                    if (!isNaN(date.getTime())) {
                        counts[date.getDay()] += 1;
                    }
                }
            });
            
            if (charts.weekday) charts.weekday.destroy();
            
            charts.weekday = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: weekdays,
                    datasets: [{
                        label: 'ì˜ˆì•½ ê±´ìˆ˜',
                        data: counts,
                        backgroundColor: 'rgba(0,255,136,0.2)',
                        borderColor: '#00ff88',
                        pointBackgroundColor: '#00ff88',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#00ff88'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { 
                                color: '#888',
                                font: { size: 12 }
                            },
                            ticks: { 
                                display: false,
                                stepSize: Math.ceil(Math.max(...counts) / 5)
                            }
                        }
                    }
                }
            });
        }
        
        // ============================================
        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        // ============================================
        
        function updateRecentTable(data) {
            const tbody = document.getElementById('recentBookingsTable');
            if (!tbody) return;
            
            const recent = data.slice(0, 10);
            
            if (recent.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #888;">
                            ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = recent.map(b => {
                const status = (b.status || '').toLowerCase();
                let statusClass = 'pending';
                let statusText = b.status || 'ì ‘ìˆ˜';
                
                if (status === 'ì™„ë£Œ' || status === 'completed') {
                    statusClass = 'up';
                    statusText = 'ì™„ë£Œ';
                } else if (status === 'ì…ê¸ˆ' || status === 'paid') {
                    statusClass = 'up';
                    statusText = 'ì…ê¸ˆì™„ë£Œ';
                } else if (status === 'ìŠ¤ì¼€ì¤„í”½ìŠ¤' || status === 'scheduled') {
                    statusClass = 'stable';
                    statusText = 'ìŠ¤ì¼€ì¤„í™•ì •';
                } else if (status === 'ì‘ì—…ì‹œì‘' || status === 'ì‘ì—…ì¤‘' || status === 'started') {
                    statusClass = 'stable';
                    statusText = 'ì‘ì—…ì¤‘';
                } else if (status === 'í™•ì •' || status === 'confirmed') {
                    statusClass = 'stable';
                    statusText = 'í™•ì •';
                } else if (status === 'ì ‘ìˆ˜' || status === 'received') {
                    statusClass = 'pending';
                    statusText = 'ì ‘ìˆ˜';
                } else if (status === 'ì·¨ì†Œ' || status === 'cancelled') {
                    statusClass = 'down';
                    statusText = 'ì·¨ì†Œ';
                }
                
                // ì•„íŒŒíŠ¸ ì´ë¦„ ê°„ì†Œí™”
                const aptName = (b.apartment || '-').substring(0, 15);
                // ì„œë¹„ìŠ¤ ì´ë¦„ ê°„ì†Œí™”
                const serviceName = (b.items || '-').substring(0, 20);
                
                return `
                    <tr>
                        <td style="color: #00AEEF; font-weight: 600;">#${b.number || '-'}</td>
                        <td>${b.name || '-'}</td>
                        <td>${aptName}</td>
                        <td>${serviceName}</td>
                        <td>${b.serviceDate || '-'}</td>
                        <td style="font-weight: 600;">â‚©${(b.revenue || 0).toLocaleString()}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        // ============================================
        // ì „ì²´ ë°ì´í„° ë Œë”ë§
        // ============================================
        
        function renderAllData(data) {
            updateKPIs(data);
            createRevenueChart(data);
            createApartmentChart(data);
            createServiceChart(data);
            createManagerChart(data);
            createWeekdayChart(data);
            updateRecentTable(data);
        }
        
        // ============================================
        // ìƒˆë¡œê³ ì¹¨
        // ============================================
        
        async function refreshAll() {
            if (isLoading) return;
            
            isLoading = true;
            const refreshBtn = document.getElementById('refreshBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (refreshBtn) refreshBtn.classList.add('loading');
            
            // ì²« ë¡œë“œ ì‹œì—ë§Œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            if (!lastFetchTime && loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
            
            try {
                const data = await fetchBookings();
                renderAllData(data);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ko-KR');
            } catch (error) {
                
            } finally {
                isLoading = false;
                if (refreshBtn) refreshBtn.classList.remove('loading');
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        }
        
        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        
        window.addEventListener('load', () => {
            
            
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            refreshAll();
            
            // â­ í´ë§ ê´€ë¦¬ (ë°±ê·¸ë¼ìš´ë“œ ì‹œ ì¤‘ì§€)
            let pollingInterval = null;
            
            function startPolling() {
                if (!pollingInterval) {
                    pollingInterval = setInterval(refreshAll, 60000);
                }
            }
            
            function stopPolling() {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopPolling();
                } else {
                    refreshAll();
                    startPolling();
                }
            });
            
            startPolling();
        });
        
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSettings();
            }
        });
    </script>
</body>
</html>
