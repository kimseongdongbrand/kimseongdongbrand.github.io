<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚´ ì˜ˆì•½ ì¡°íšŒ | ê¹¨ë—í•œì§‘</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            padding: 30px 0;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .search-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 16px;
        }
        .input-group {
            margin-bottom: 16px;
        }
        .input-group label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .input-group input {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            letter-spacing: 2px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .search-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .search-btn:active {
            transform: scale(0.98);
        }
        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* ì˜ˆì•½ ëª©ë¡ */
        .booking-list {
            display: none;
        }
        .booking-list.show {
            display: block;
        }
        .booking-list h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .booking-count {
            background: #667eea;
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .booking-card {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        .booking-card.past {
            opacity: 0.6;
            border-left-color: #999;
        }
        .booking-card.cancelled {
            opacity: 0.5;
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .booking-id {
            font-size: 12px;
            color: #999;
        }
        .booking-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .status-received { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-scheduled { background: #e2d5f5; color: #6f42c1; }
        .status-started { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-paid { background: #28a745; color: white; }
        .status-cancelled { background: #e74c3c; color: white; }
        
        .booking-date {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        .booking-info {
            font-size: 14px;
            color: #666;
            line-height: 1.8;
        }
        .booking-info span {
            display: block;
        }
        
        .cancel-btn {
            width: 100%;
            padding: 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }
        .cancel-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        /* ë¡œë”© */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* í™•ì¸ ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 360px;
            width: 100%;
            text-align: center;
        }
        .modal h3 {
            font-size: 20px;
            margin-bottom: 12px;
        }
        .modal p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-btns {
            display: flex;
            gap: 12px;
        }
        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-btn.cancel {
            background: #e0e0e0;
            color: #333;
        }
        .modal-btn.confirm {
            background: #e74c3c;
            color: white;
        }
        
        /* í•˜ë‹¨ ë§í¬ */
        .footer-link {
            text-align: center;
            margin-top: 20px;
        }
        .footer-link a {
            color: white;
            text-decoration: none;
            font-size: 15px;
            opacity: 0.9;
        }
        
        /* ê³ ê°ì„¼í„° */
        .help-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            text-align: center;
        }
        .help-section p {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .help-phone {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ ë‚´ ì˜ˆì•½ ì¡°íšŒ</h1>
            <p>ì˜ˆì•½ í™•ì¸ ë° ì·¨ì†Œ</p>
        </div>
        
        <div class="card search-section">
            <h2>ğŸ” ì˜ˆì•½ ì°¾ê¸°</h2>
            <div class="input-group">
                <label>ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="phoneInput" placeholder="010-1234-5678" maxlength="13">
            </div>
            <button class="search-btn" id="searchBtn" onclick="searchBookings()">
                ì˜ˆì•½ ì¡°íšŒí•˜ê¸°
            </button>
        </div>
        
        <div class="card loading" id="loadingSection">
            <div class="spinner"></div>
            <div>ì˜ˆì•½ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</div>
        </div>
        
        <div class="card booking-list" id="bookingList">
            <h2>ğŸ“… ë‚˜ì˜ ì˜ˆì•½ <span class="booking-count" id="bookingCount">0</span></h2>
            <div id="bookingsContainer"></div>
        </div>
        
        <div class="footer-link">
            <a href="customer_booking_final.html">â† ìƒˆ ì˜ˆì•½í•˜ê¸°</a>
        </div>
    </div>
    
    <!-- ì·¨ì†Œ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <h3>âš ï¸ ì˜ˆì•½ ì·¨ì†Œ</h3>
            <p id="cancelModalText">ì •ë§ ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeCancelModal()">ì•„ë‹ˆì˜¤</button>
                <button class="modal-btn confirm" onclick="confirmCancel()">ì˜ˆ, ì·¨ì†Œí•©ë‹ˆë‹¤</button>
            </div>
        </div>
    </div>
    
    <script>
        // âš ï¸ Google Apps Script URL - ì‹¤ì œ ë°°í¬ëœ URLë¡œ ë³€ê²½í•˜ì„¸ìš”
        const API_URL = 'https://script.google.com/macros/s/AKfycbxRKOfqpoMwV_PGWFOt-O32i1cz9ZKH9SJutoJ9q8au6GwBQ72PyY7aEtVOrSawltBLBA/exec';
        
        let currentPhone = '';
        let cancelTargetId = '';
        
        // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
        document.getElementById('phoneInput').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 3 && value.length <= 7) {
                value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 7) {
                value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
            e.target.value = value;
        });
        
        // ì—”í„°í‚¤ ê²€ìƒ‰
        document.getElementById('phoneInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBookings();
            }
        });
        
        async function searchBookings() {
            const phone = document.getElementById('phoneInput').value.trim();
            
            if (!phone || phone.length < 10) {
                alert('ì „í™”ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            currentPhone = phone;
            
            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('loadingSection').classList.add('show');
            document.getElementById('bookingList').classList.remove('show');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'lookupBooking',
                        phone: phone
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('loadingSection').classList.remove('show');
                document.getElementById('searchBtn').disabled = false;
                
                if (result.success) {
                    renderBookings(result.bookings || []);
                } else {
                    alert('ì¡°íšŒ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
            } catch (error) {
                document.getElementById('loadingSection').classList.remove('show');
                document.getElementById('searchBtn').disabled = false;
                alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        function renderBookings(bookings) {
            const container = document.getElementById('bookingsContainer');
            document.getElementById('bookingCount').textContent = bookings.length;
            document.getElementById('bookingList').classList.add('show');
            
            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <div>í•´ë‹¹ ì „í™”ë²ˆí˜¸ë¡œ<br>ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            bookings.forEach(b => {
                const statusClass = getStatusClass(b.status);
                const cardClass = b.status === 'cancelled' ? 'cancelled' : (b.isPast ? 'past' : '');
                
                const card = document.createElement('div');
                card.className = `booking-card ${cardClass}`;
                
                card.innerHTML = `
                    <div class="booking-header">
                        <div class="booking-id">ì˜ˆì•½ë²ˆí˜¸: ${b.id || b.number || '-'}</div>
                        <div class="booking-status ${statusClass}">${b.statusText}</div>
                    </div>
                    <div class="booking-date">ğŸ“… ${formatDate(b.serviceDate)}</div>
                    <div class="booking-info">
                        <span>ğŸ“ ${b.address}</span>
                        <span>ğŸ”§ ${b.service}</span>
                        ${b.manager ? `<span>ğŸ‘· ë‹´ë‹¹: ${b.manager}</span>` : ''}
                        ${b.revenue ? `<span>ğŸ’° ${Number(b.revenue).toLocaleString()}ì›</span>` : ''}
                    </div>
                    ${b.canCancel ? `<button class="cancel-btn" onclick="showCancelModal('${b.id}', '${formatDate(b.serviceDate)}')">ì˜ˆì•½ ì·¨ì†Œí•˜ê¸°</button>` : ''}
                `;
                
                container.appendChild(card);
            });
        }
        
        function getStatusClass(status) {
            const map = {
                'received': 'status-received',
                'confirmed': 'status-confirmed',
                'scheduled': 'status-scheduled',
                'started': 'status-started',
                'completed': 'status-completed',
                'paid': 'status-paid',
                'cancelled': 'status-cancelled'
            };
            return map[status] || 'status-received';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'ë¯¸ì •';
            const d = new Date(dateStr);
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return `${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${days[d.getDay()]})`;
        }
        
        function showCancelModal(bookingId, dateStr) {
            cancelTargetId = bookingId;
            document.getElementById('cancelModalText').innerHTML = 
                `<strong>${dateStr}</strong> ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><br>ì·¨ì†Œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
            document.getElementById('cancelModal').classList.add('show');
        }
        
        function closeCancelModal() {
            document.getElementById('cancelModal').classList.remove('show');
            cancelTargetId = '';
        }
        
        async function confirmCancel() {
            if (!cancelTargetId || !currentPhone) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            closeCancelModal();
            document.getElementById('loadingSection').classList.add('show');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'cancelBooking',
                        id: cancelTargetId,
                        phone: currentPhone
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('loadingSection').classList.remove('show');
                
                if (result.success) {
                    alert('âœ… ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    searchBookings(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('âŒ ì·¨ì†Œ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
            } catch (error) {
                document.getElementById('loadingSection').classList.remove('show');
                alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
    </script>
</body>
</html>
