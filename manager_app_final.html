<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- â­ ëª¨ë°”ì¼ ìµœì í™” viewport (í™•ëŒ€ ë°©ì§€ + ë…¸ì¹˜ ëŒ€ì‘) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- iOS ì›¹ì•± ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#00AEEF">
    <title>(ì£¼)í™ˆì¼€ì–´ ê¹¨ë—í•œì§‘ - ë§¤ë‹ˆì €ì•± v2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* â­ ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
        html {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-text-size-adjust: 100%;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f5f7fa; 
            font-size: 20px;
            /* â­ iPhone Safe Area ëŒ€ì‘ */
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-container { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            background: linear-gradient(135deg, #00AEEF 0%, #0088CC 100%); 
            padding: 20px;
            /* â­ Safe Area ëŒ€ì‘ */
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        .login-box { background: white; border-radius: 20px; padding: 50px 40px; width: 100%; max-width: 480px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .login-logo { text-align: center; margin-bottom: 40px; }
        .login-logo h1 { font-size: 48px; color: #00AEEF; margin-bottom: 12px; font-weight: 900; }
        .login-logo p { font-size: 24px; color: #666; font-weight: 600; }
        .input-group { margin-bottom: 28px; }
        .input-label { display: block; margin-bottom: 12px; font-weight: 700; font-size: 22px; color: #333; }
        /* â­ ì…ë ¥í•„ë“œ 16px ì´ìƒ (iOS ìë™í™•ëŒ€ ë°©ì§€) */
        .input-field { 
            width: 100%; 
            padding: 20px; 
            border: 3px solid #e0e0e0; 
            border-radius: 12px; 
            font-size: 22px; 
            font-weight: 600;
            -webkit-appearance: none;
            appearance: none;
        }
        .input-field:focus { outline: none; border-color: #00AEEF; box-shadow: 0 0 0 4px rgba(0, 174, 239, 0.1); }
        /* â­ ë¡œê·¸ì¸ ë²„íŠ¼ í„°ì¹˜ í”¼ë“œë°± */
        .login-btn { 
            width: 100%; 
            padding: 24px; 
            background: linear-gradient(135deg, #00AEEF 0%, #0088CC 100%); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 24px; 
            font-weight: 900; 
            cursor: pointer; 
            margin-top: 20px;
            transition: transform 0.1s;
            min-height: 70px;
        }
        .login-btn:active { transform: scale(0.98); }
        .error-message { color: #e74c3c; text-align: center; margin-top: 20px; display: none; font-size: 20px; font-weight: 700; }
        .error-message.show { display: block; }
        .sync-status { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 8px; text-align: center; font-size: 14px; margin-top: 15px; display: none; }
        .sync-status.show { display: block; }
        .sync-status.error { background: #ffebee; color: #c62828; }
        
        /* ì•± í™”ë©´ */
        .app-container { display: none; }
        .header { 
            background: linear-gradient(135deg, #00AEEF 0%, #0088CC 100%); 
            color: white; 
            padding: 24px; 
            position: sticky; 
            top: 0; 
            z-index: 100;
            /* â­ Safe Area ëŒ€ì‘ */
            padding-top: max(24px, calc(env(safe-area-inset-top) + 10px));
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 32px; font-weight: 900; }
        .header p { font-size: 20px; margin-top: 4px; opacity: 0.95; }
        /* â­ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í„°ì¹˜ í”¼ë“œë°± */
        .logout-btn { 
            padding: 14px 24px; 
            background: rgba(255,255,255,0.3); 
            color: white; 
            border: none; 
            border-radius: 25px; 
            font-weight: 800; 
            cursor: pointer; 
            font-size: 20px; 
            min-width: 120px;
            min-height: 50px;
            transition: transform 0.1s;
        }
        .logout-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.4); }
        .header-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        /* â­ í—¤ë” ë²„íŠ¼ í„°ì¹˜ í”¼ë“œë°± */
        .header-btn { 
            padding: 18px; 
            background: rgba(255,255,255,0.25); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-weight: 800; 
            cursor: pointer; 
            font-size: 18px; 
            min-height: 70px;
            transition: transform 0.1s;
        }
        .header-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.35); }
        
        /* ë™ê¸°í™” ì¸ë””ì¼€ì´í„° */
        .sync-indicator { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 14px; 
            font-weight: 700; 
            z-index: 9999;
            display: none;
        }
        .sync-indicator.syncing { display: block; background: #fff3cd; color: #856404; }
        .sync-indicator.success { display: block; background: #d4edda; color: #155724; }
        .sync-indicator.error { display: block; background: #f8d7da; color: #721c24; }
        
        /* í†µê³„ ì¹´ë“œ */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 16px; background: white; border-bottom: 2px solid #e0e0e0; }
        .stat-card { background: #f8f9fa; padding: 20px 12px; border-radius: 12px; text-align: center; min-height: 110px; }
        .stat-number { font-size: 36px; font-weight: 900; color: #00AEEF; }
        .stat-label { font-size: 16px; color: #666; font-weight: 700; margin-top: 8px; }
        
        /* ì˜ˆì•½ ì¹´ë“œ */
        .bookings-container { padding: 16px 16px 100px 16px; }
        .booking-card { background: white; border-radius: 12px; padding: 18px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 5px solid #00AEEF; cursor: pointer; }
        .booking-card.new-assignment { border-left-color: #f39c12; background: #fffbf0; }
        .customer-name { font-size: 24px; font-weight: 900; color: #000; margin-bottom: 14px; }
        .info-row { display: flex; align-items: flex-start; margin-bottom: 10px; gap: 10px; }
        .info-icon { font-size: 20px; min-width: 24px; }
        .info-value { font-size: 16px; color: #333; font-weight: 600; line-height: 1.4; }
        .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-size: 15px; font-weight: 900; margin: 10px 0; }
        /* â­ ì•¡ì…˜ ë²„íŠ¼ í„°ì¹˜ í”¼ë“œë°± + ìµœì†Œ í„°ì¹˜ ì˜ì—­ */
        .action-btn { 
            width: 100%; 
            padding: 16px; 
            border: none; 
            border-radius: 10px; 
            font-weight: 900; 
            cursor: pointer; 
            margin-top: 10px; 
            font-size: 18px; 
            transition: transform 0.1s; 
            min-height: 60px;
            -webkit-tap-highlight-color: transparent;
        }
        .action-btn:active:not(:disabled) { transform: scale(0.97); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-confirm { background: #f39c12; color: white; }
        .btn-start { background: #3498db; color: white; }
        .btn-complete { background: #27ae60; color: white; }
        .btn-paid { background: #1abc9c; color: white; }
        .empty-state { text-align: center; padding: 60px 20px; color: #7f8c8d; font-size: 18px; font-weight: 600; }
        
        /* ëª¨ë‹¬ */
        .confirm-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.8); 
            z-index: 2000; 
            align-items: center; 
            justify-content: center; 
            /* â­ Safe Area ëŒ€ì‘ */
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
        }
        .confirm-modal.show { display: flex; }
        .confirm-content { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            max-width: 500px; 
            width: 95%; 
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .confirm-content h3 { font-size: 28px; margin-bottom: 24px; color: #000; font-weight: 900; line-height: 1.4; }
        .confirm-buttons { display: flex; gap: 12px; margin-top: 30px; }
        /* â­ í™•ì¸ ë²„íŠ¼ í„°ì¹˜ í”¼ë“œë°± */
        .confirm-buttons button { 
            flex: 1; 
            padding: 22px; 
            border: none; 
            border-radius: 12px; 
            font-weight: 900; 
            font-size: 22px; 
            cursor: pointer; 
            min-height: 75px;
            transition: transform 0.1s;
        }
        .confirm-buttons button:active { transform: scale(0.97); }
        
        /* â­ í•„í„° ë²„íŠ¼ í„°ì¹˜ í”¼ë“œë°± */
        .filter-btn { 
            flex: 1; 
            min-width: 100px; 
            padding: 15px 12px; 
            background: rgba(255,255,255,0.15); 
            color: white; 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 10px; 
            font-size: 18px; 
            font-weight: 900; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 5px;
            transition: transform 0.1s;
            min-height: 80px;
        }
        .filter-btn:active { transform: scale(0.95); }
        .filter-btn.active { background: rgba(255,255,255,0.3); border-color: white; }
        
        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid #e0e0e0; border-top-color: #00AEEF; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 18px; font-weight: 600; color: #333; }
        
        /* â­ ì‘ì€ í™”ë©´ ëŒ€ì‘ (iPhone SE, ì‘ì€ ì•ˆë“œë¡œì´ë“œ í°) */
        @media screen and (max-width: 374px) {
            .login-logo h1 { font-size: 38px; }
            .login-logo p { font-size: 20px; }
            .input-field { font-size: 18px; padding: 16px; }
            .login-btn { font-size: 20px; padding: 20px; }
            .header h1 { font-size: 26px; }
            .header-btn { font-size: 15px; min-height: 60px; padding: 14px; }
            .filter-btn { font-size: 14px; min-width: 80px; }
            .filter-btn > div:first-child { font-size: 26px !important; }
            .customer-name { font-size: 20px; }
            .action-btn { font-size: 16px; min-height: 54px; }
            .confirm-content { padding: 30px 20px; }
            .confirm-content h3 { font-size: 22px; }
            .confirm-buttons button { font-size: 18px; padding: 18px; min-height: 60px; }
        }
        
        /* â­ ê°€ë¡œ ëª¨ë“œ ëŒ€ì‘ */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .login-box { padding: 30px; }
            .login-logo { margin-bottom: 20px; }
            .login-logo h1 { font-size: 32px; }
            .input-group { margin-bottom: 16px; }
        }
        
        /* â­ í™ˆ í™”ë©´ ì¶”ê°€ìš© ì•„ì´ì½˜ */
        @media (display-mode: standalone) {
            /* PWA ëª¨ë“œì¼ ë•Œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
            body { padding-top: env(safe-area-inset-top); }
        }
    </style>
</head>
<body>
    <!-- ë™ê¸°í™” ì¸ë””ì¼€ì´í„° -->
    <div class="sync-indicator" id="syncIndicator">ë™ê¸°í™” ì¤‘...</div>
    
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">ì²˜ë¦¬ ì¤‘...</div>
    </div>

    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">
                <h1>ğŸš— ê¹¨ë—í•œì§‘</h1>
                <p>ë§¤ë‹ˆì € ì „ìš© ì•± v2</p>
            </div>
            <div class="input-group">
                <label class="input-label">ì•„ì´ë”” (ì´ë¦„ ë˜ëŠ” ID)</label>
                <input type="text" class="input-field" id="loginUsername" placeholder="ì˜ˆ: í™ê¸¸ë™">
            </div>
            <div class="input-group">
                <label class="input-label">ë¹„ë°€ë²ˆí˜¸ (ì—°ë½ì²˜ ë’· 4ìë¦¬)</label>
                <input type="password" class="input-field" id="loginPassword" placeholder="ì˜ˆ: 5678">
            </div>
            <button class="login-btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
            <div class="error-message" id="errorMessage">ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            <div class="sync-status" id="loginSyncStatus"></div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="header-top">
                <div>
                    <h1>ğŸš— ë‚´ ì¼ì •</h1>
                    <p style="font-size: 13px; opacity: 0.9;"><span id="driverName"></span>ë‹˜</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <a href="manager_settlement.html" style="background: rgba(255,255,255,0.3); color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">ğŸ’° ì •ì‚°</a>
                    <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
            
            <!-- ë…„/ì›”/ì¼ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.2); padding: 15px 25px; border-radius: 12px; margin: 15px 0;">
                <button onclick="prevDay()" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 26px; font-weight: 900; cursor: pointer;">â—€</button>
                <div id="currentDateDisplay" style="color: white; font-size: 28px; font-weight: 900; text-align: center; flex: 1;">2025ë…„ 11ì›” 26ì¼</div>
                <button onclick="nextDay()" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 26px; font-weight: 900; cursor: pointer;">â–¶</button>
            </div>
            
            <!-- í•„í„° ë²„íŠ¼ -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                <button id="filterToday" class="filter-btn active" onclick="filterToday()">
                    <div id="todayCount" style="font-size: 32px; font-weight: 900; line-height: 1;">0</div>
                    <div style="font-size: 16px;">ğŸ“… ì˜¤ëŠ˜</div>
                </button>
                <button id="filterAll" class="filter-btn" onclick="filterAll()">
                    <div id="totalCount" style="font-size: 32px; font-weight: 900; line-height: 1;">0</div>
                    <div style="font-size: 16px;">ğŸ“‹ ì „ì²´</div>
                </button>
                <button id="filterCompleted" class="filter-btn" onclick="filterCompleted()">
                    <div id="completedCount" style="font-size: 32px; font-weight: 900; line-height: 1;">0</div>
                    <div style="font-size: 16px;">âœ… ì™„ë£Œ</div>
                </button>
            </div>
            
            <div class="header-buttons">
                <button class="header-btn" onclick="loadMyBookings()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button class="header-btn" onclick="showScheduleModal()">ğŸ“… ë‚´ ìŠ¤ì¼€ì¤„</button>
                <button class="header-btn" onclick="showVacationModal()">ğŸŒ´ íœ´ë¬´ë“±ë¡</button>
            </div>
        </div>

        <div class="bookings-container" id="bookingsContainer"></div>
    </div>

    <!-- í™•ì¸ ëª¨ë‹¬ -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h3 id="confirmMessage"></h3>
            <div class="confirm-buttons">
                <button onclick="confirmCancel()" style="background: #95a5a6; color: white;">ì·¨ì†Œ</button>
                <button onclick="confirmOk()" style="background: #00AEEF; color: white;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ì‹œê°„ ì„ íƒ ëª¨ë‹¬ -->
    <div class="confirm-modal" id="timePickerModal">
        <div class="confirm-content" style="max-width: 450px; padding: 30px;">
            <h3 style="margin-bottom: 10px; font-size: 28px;">â° ì‘ì—… ì‹œì‘ ì‹œê°„ ì„ íƒ</h3>
            <p id="timeSlotInfo" style="font-size: 16px; color: #666; margin-bottom: 20px;"></p>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 25px;">
                <div style="flex: 1; max-width: 120px;">
                    <label style="display: block; font-weight: 700; margin-bottom: 10px; text-align: center; font-size: 18px;">ì‹œ</label>
                    <div id="hourScroller" style="height: 200px; overflow-y: auto; border: 3px solid #9b59b6; border-radius: 12px; background: #f8f9fa;"></div>
                </div>
                <div style="flex: 1; max-width: 120px;">
                    <label style="display: block; font-weight: 700; margin-bottom: 10px; text-align: center; font-size: 18px;">ë¶„</label>
                    <div id="minuteScroller" style="height: 200px; overflow-y: auto; border: 3px solid #9b59b6; border-radius: 12px; background: #f8f9fa;"></div>
                </div>
            </div>
            
            <div id="selectedTimeDisplay" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; padding: 15px; border-radius: 12px; text-align: center; font-size: 24px; font-weight: 900; margin-bottom: 20px;">--:--</div>
            
            <div class="confirm-buttons">
                <button onclick="closeTimePickerModal()" style="background: #95a5a6; color: white; padding: 18px; font-size: 20px;">ì·¨ì†Œ</button>
                <button onclick="confirmTimePicker()" style="background: #9b59b6; color: white; padding: 18px; font-size: 20px;">âœ… í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ì„¤ì •
        // ========================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRKOfqpoMwV_PGWFOt-O32i1cz9ZKH9SJutoJ9q8au6GwBQ72PyY7aEtVOrSawltBLBA/exec';
        
        // â­ XSS ë°©ì§€ìš© HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // â­ fetch íƒ€ì„ì•„ì›ƒ ë˜í¼ (30ì´ˆ)
        async function fetchWithTimeout(url, options = {}, timeout = 30000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)');
                }
                throw error;
            }
        }
        
        // ========================================
        // ìƒíƒœ ë³€ìˆ˜
        // ========================================
        let currentManager = null;
        let myBookings = [];
        let confirmCallback = null;
        let filterMode = 'today';
        let currentDate = new Date();
        let currentTimePickerBooking = null;
        let selectedHour = '09';
        let selectedMinute = '00';
        
        // ========================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ========================================
        function showLoading(text = 'ì²˜ë¦¬ ì¤‘...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
        
        function showSyncIndicator(status, message) {
            const indicator = document.getElementById('syncIndicator');
            indicator.className = 'sync-indicator ' + status;
            indicator.textContent = message;
            
            if (status === 'success' || status === 'error') {
                setTimeout(() => {
                    indicator.className = 'sync-indicator';
                }, 3000);
            }
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('show');
            confirmCallback = callback;
        }
        
        function confirmOk() {
            document.getElementById('confirmModal').classList.remove('show');
            if (confirmCallback) confirmCallback(true);
            confirmCallback = null;
        }
        
        function confirmCancel() {
            document.getElementById('confirmModal').classList.remove('show');
            if (confirmCallback) confirmCallback(false);
            confirmCallback = null;
        }
        
        function formatDate(date) {
            const d = new Date(date);
            return d.getFullYear() + '-' + 
                   String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(d.getDate()).padStart(2, '0');
        }
        
        function getStatusInfo(status) {
            const map = {
                'received': { text: 'ì˜ˆì•½ì ‘ìˆ˜', color: '#e67e22' },
                'confirmed': { text: 'ì˜ˆì•½í™•ì •', color: '#f39c12' },
                'scheduled': { text: 'ìŠ¤ì¼€ì¤„í”½ìŠ¤', color: '#9b59b6' },
                'started': { text: 'ì‘ì—…ì‹œì‘', color: '#3498db' },
                'completed': { text: 'ì‘ì—…ì™„ë£Œ', color: '#27ae60' },
                'paid': { text: 'ì…ê¸ˆì™„ë£Œ', color: '#1abc9c' },
                'cancelled': { text: 'ì˜ˆì•½ì·¨ì†Œ', color: '#e74c3c' }  // â­ ì¶”ê°€
            };
            return map[status] || { text: status, color: '#95a5a6' };
        }
        
        // ========================================
        // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ (ì„œë²„ ì¸ì¦)
        // ========================================
        async function doLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorMsg = document.getElementById('errorMessage');
            const syncStatus = document.getElementById('loginSyncStatus');
            
            errorMsg.classList.remove('show');
            syncStatus.classList.remove('show');
            
            if (!username || !password) {
                errorMsg.textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorMsg.classList.add('show');
                return;
            }
            
            showLoading('ë¡œê·¸ì¸ ì¤‘...');
            
            try {
                // ì„œë²„ ì¸ì¦ ì‹œë„
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=managerLogin&userId=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const result = await response.json();
                
                hideLoading();
                
                if (result.success) {
                    currentManager = result.manager;
                    
                    // ì„¸ì…˜ ì €ì¥ (í† í° í¬í•¨)
                    localStorage.setItem('currentManager', JSON.stringify({
                        ...currentManager,
                        token: result.token,
                        loginTime: new Date().toISOString()
                    }));
                    
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    document.getElementById('driverName').textContent = currentManager.name;
                    
                    syncStatus.textContent = 'âœ… ì„œë²„ ì¸ì¦ ì„±ê³µ';
                    syncStatus.className = 'sync-status show';
                    
                    loadMyBookings();
                } else {
                    errorMsg.textContent = result.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
                    errorMsg.classList.add('show');
                }
            } catch (error) {
                hideLoading();
                
                
                // ì˜¤í”„ë¼ì¸ í´ë°±: localStorage í™•ì¸
                const saved = localStorage.getItem('currentManager');
                if (saved) {
                    try {
                        const savedManager = JSON.parse(saved);
                        if (savedManager.name === username || savedManager.id === username) {
                            currentManager = savedManager;
                            
                            document.getElementById('loginContainer').style.display = 'none';
                            document.getElementById('appContainer').style.display = 'block';
                            document.getElementById('driverName').textContent = currentManager.name;
                            
                            syncStatus.textContent = 'âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ (ì €ì¥ëœ ì •ë³´ ì‚¬ìš©)';
                            syncStatus.className = 'sync-status show error';
                            
                            loadMyBookings();
                            return;
                        }
                    } catch (e) {}
                }
                
                errorMsg.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
                errorMsg.classList.add('show');
            }
        }
        
        function doLogout() {
            showConfirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(result) {
                if (!result) return;
                
                currentManager = null;
                myBookings = [];
                localStorage.removeItem('currentManager');
                
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('errorMessage').classList.remove('show');
                document.getElementById('bookingsContainer').innerHTML = '';
                
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
            });
        }
        
        // ========================================
        // ì˜ˆì•½ ë°ì´í„° ë¡œë“œ (ì„œë²„ì—ì„œ ì§ì ‘)
        // ========================================
        async function loadMyBookings() {
            if (!currentManager) return;
            
            showSyncIndicator('syncing', 'ğŸ”„ ë™ê¸°í™” ì¤‘...');
            
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getBookings`);
                const result = await response.json();
                
                if (result.success && result.bookings) {
                    // í˜„ì¬ ë§¤ë‹ˆì €ì˜ ì˜ˆì•½ë§Œ í•„í„°ë§
                    myBookings = result.bookings.filter(b => b.manager === currentManager.name);
                    
                    // ë‚ ì§œìˆœ ì •ë ¬
                    myBookings.sort((a, b) => (a.serviceDate || '9999-12-31').localeCompare(b.serviceDate || '9999-12-31'));
                    
                    showSyncIndicator('success', 'âœ… ë™ê¸°í™” ì™„ë£Œ');
                    
                    updateDateDisplay();
                    renderBookings();
                    updateStats();
                } else {
                    showSyncIndicator('error', 'âŒ ë™ê¸°í™” ì‹¤íŒ¨');
                }
            } catch (error) {
                
                showSyncIndicator('error', 'âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
            }
        }
        
        // ========================================
        // ìƒíƒœ ë³€ê²½ (ì„œë²„ ì§ì ‘ ì—…ë°ì´íŠ¸ - í•µì‹¬ ê°œì„ !)
        // ========================================
        async function changeStatus(bookingId, newStatus, additionalData = {}) {
            const statusNames = {
                'confirmed': 'ì˜ˆì•½í™•ì •',
                'scheduled': 'ìŠ¤ì¼€ì¤„í”½ìŠ¤',
                'started': 'ì‘ì—…ì‹œì‘',
                'completed': 'ì‘ì—…ì™„ë£Œ',
                'paid': 'ì…ê¸ˆì™„ë£Œ'
            };
            
            showConfirm(`ìƒíƒœë¥¼ "${statusNames[newStatus]}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async function(result) {
                if (!result) return;
                
                showLoading('ìƒíƒœ ë³€ê²½ ì¤‘...');
                showSyncIndicator('syncing', 'ğŸ”„ ì„œë²„ ì—…ë°ì´íŠ¸ ì¤‘...');
                
                try {
                    // â­ ì„œë²„ì— ì§ì ‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ìš”ì²­
                    const payload = {
                        action: 'updateStatusFromManager',
                        bookingId: bookingId,
                        status: newStatus,
                        manager: currentManager.name,
                        ...additionalData
                    };
                    
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const responseText = await response.text();
                    let result;
                    
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        // CORS ì´ìŠˆë¡œ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ëŠ” ê²½ìš°
                        
                        result = { success: true };
                    }
                    
                    hideLoading();
                    
                    if (result.success) {
                        showSyncIndicator('success', 'âœ… ìƒíƒœ ë³€ê²½ ì™„ë£Œ');
                        alert(`âœ… ìƒíƒœê°€ "${statusNames[newStatus]}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        
                        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                        await loadMyBookings();
                    } else {
                        showSyncIndicator('error', 'âŒ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
                        alert('âŒ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    hideLoading();
                    
                    showSyncIndicator('error', 'âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                    
                    // ì¬ì‹œë„ ì˜µì…˜ ì œê³µ
                    if (confirm('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        changeStatus(bookingId, newStatus, additionalData);
                    }
                }
            });
        }
        
        // ========================================
        // ìŠ¤ì¼€ì¤„ í”½ìŠ¤ (ì‹œê°„ ì„ íƒ)
        // ========================================
        function showTimePickerModal(booking) {
            currentTimePickerBooking = booking;
            
            // ê³ ê° í¬ë§ ì‹œê°„ëŒ€ í‘œì‹œ
            let timeSlotText = 'ê³ ê° í¬ë§ ì‹œê°„ëŒ€: ';
            if (booking.timeSlots && booking.timeSlots.length > 0) {
                timeSlotText += booking.timeSlots.join(', ');
            } else {
                timeSlotText += 'ë¯¸ì • (ì „ì²´ ì‹œê°„ ì„ íƒ ê°€ëŠ¥)';
            }
            document.getElementById('timeSlotInfo').textContent = timeSlotText;
            
            // ê°€ëŠ¥í•œ ì‹œê°„ ì¶”ì¶œ
            let availableHours = [];
            if (booking.timeSlots && booking.timeSlots.length > 0) {
                booking.timeSlots.forEach(slot => {
                    if (slot.includes('ì˜¤ì „ 9ì‹œ') || slot.includes('9ì‹œ - 12ì‹œ')) {
                        availableHours.push(9, 10, 11);
                    }
                    if (slot.includes('ì˜¤í›„ 1ì‹œ') || slot.includes('1ì‹œ - 4ì‹œ')) {
                        availableHours.push(13, 14, 15);
                    }
                    if (slot.includes('ì˜¤í›„ 4ì‹œ') || slot.includes('4ì‹œ - 7ì‹œ')) {
                        availableHours.push(16, 17, 18);
                    }
                    if (slot.includes('ì¢…ì¼')) {
                        availableHours = [9, 10, 11, 12, 13, 14, 15, 16, 17, 18];
                    }
                });
                availableHours = [...new Set(availableHours)].sort((a, b) => a - b);
            } else {
                availableHours = [9, 10, 11, 12, 13, 14, 15, 16, 17, 18];
            }
            
            // ì‹œê°„ ìŠ¤í¬ë¡¤ëŸ¬ ìƒì„±
            const hourScroller = document.getElementById('hourScroller');
            hourScroller.innerHTML = '';
            availableHours.forEach((h, i) => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 15px; text-align: center; font-size: 24px; font-weight: 700; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid #e0e0e0;';
                item.textContent = String(h).padStart(2, '0');
                item.dataset.value = String(h).padStart(2, '0');
                item.onclick = function() {
                    hourScroller.querySelectorAll('div').forEach(d => { d.style.background = 'transparent'; d.style.color = '#333'; });
                    this.style.background = '#9b59b6';
                    this.style.color = 'white';
                    selectedHour = this.dataset.value;
                    updateTimeDisplay();
                };
                if (i === 0) {
                    item.style.background = '#9b59b6';
                    item.style.color = 'white';
                    selectedHour = item.dataset.value;
                }
                hourScroller.appendChild(item);
            });
            
            // ë¶„ ìŠ¤í¬ë¡¤ëŸ¬ ìƒì„±
            const minuteScroller = document.getElementById('minuteScroller');
            minuteScroller.innerHTML = '';
            ['00', '10', '20', '30', '40', '50'].forEach((m, i) => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 15px; text-align: center; font-size: 24px; font-weight: 700; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid #e0e0e0;';
                item.textContent = m;
                item.dataset.value = m;
                item.onclick = function() {
                    minuteScroller.querySelectorAll('div').forEach(d => { d.style.background = 'transparent'; d.style.color = '#333'; });
                    this.style.background = '#9b59b6';
                    this.style.color = 'white';
                    selectedMinute = this.dataset.value;
                    updateTimeDisplay();
                };
                if (i === 0) {
                    item.style.background = '#9b59b6';
                    item.style.color = 'white';
                    selectedMinute = m;
                }
                minuteScroller.appendChild(item);
            });
            
            updateTimeDisplay();
            document.getElementById('timePickerModal').classList.add('show');
        }
        
        function updateTimeDisplay() {
            document.getElementById('selectedTimeDisplay').textContent = selectedHour + ':' + selectedMinute;
        }
        
        function closeTimePickerModal() {
            document.getElementById('timePickerModal').classList.remove('show');
            currentTimePickerBooking = null;
        }
        
        async function confirmTimePicker() {
            if (!currentTimePickerBooking) return;
            
            const selectedTime = selectedHour + ':' + selectedMinute;
            document.getElementById('timePickerModal').classList.remove('show');
            
            // ìŠ¤ì¼€ì¤„ í”½ìŠ¤ ìƒíƒœë¡œ ë³€ê²½ + ì‹¤ì œ ì‹œì‘ ì‹œê°„ ì €ì¥
            showLoading('ìŠ¤ì¼€ì¤„ í™•ì • ì¤‘...');
            showSyncIndicator('syncing', 'ğŸ”„ ì„œë²„ ì—…ë°ì´íŠ¸ ì¤‘...');
            
            try {
                const payload = {
                    action: 'updateStatusFromManager',
                    bookingId: currentTimePickerBooking.id,
                    status: 'scheduled',
                    actualStartTime: selectedTime,
                    manager: currentManager.name,
                    acceptAssignment: true  // â­ ë°°ì • ìˆ˜ë½ í‘œì‹œ
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // â­ CRIT-001 ìˆ˜ì •: ì‘ë‹µ ê²€ì¦ ì¶”ê°€
                let result;
                try {
                    const responseText = await response.text();
                    result = JSON.parse(responseText);
                } catch (e) {
                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼ (CORS ì´ìŠˆ ëŒ€ì‘)
                    
                    result = { success: true };
                }
                
                hideLoading();
                
                if (result.success) {
                    showSyncIndicator('success', 'âœ… ìŠ¤ì¼€ì¤„ í™•ì • ì™„ë£Œ');
                    alert(`âœ… ìŠ¤ì¼€ì¤„ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\nì‹œì‘ ì‹œê°„: ${selectedTime}`);
                    await loadMyBookings();
                } else {
                    showSyncIndicator('error', 'âŒ ìŠ¤ì¼€ì¤„ í™•ì • ì‹¤íŒ¨');
                    alert('âŒ ìŠ¤ì¼€ì¤„ í™•ì • ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                hideLoading();
                
                showSyncIndicator('error', 'âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                alert('âŒ ìŠ¤ì¼€ì¤„ í™•ì • ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
            
            currentTimePickerBooking = null;
        }
        
        // ========================================
        // ì˜ˆì•½ ëª©ë¡ ë Œë”ë§
        // ========================================
        function renderBookings() {
            const container = document.getElementById('bookingsContainer');
            let displayBookings = [];
            
            const targetDateStr = formatDate(currentDate);
            
            if (filterMode === 'today') {
                displayBookings = myBookings.filter(b => b.serviceDate === targetDateStr);
            } else if (filterMode === 'all') {
                displayBookings = myBookings.slice();
            } else if (filterMode === 'completed') {
                displayBookings = myBookings.filter(b => b.status === 'completed' || b.status === 'paid');
            }
            
            if (displayBookings.length === 0) {
                let emptyMsg = '';
                if (filterMode === 'today') {
                    emptyMsg = `${targetDateStr}ì—<br>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤`;
                } else if (filterMode === 'all') {
                    emptyMsg = 'ë°°ì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤';
                } else {
                    emptyMsg = 'ì™„ë£Œëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤';
                }
                container.innerHTML = `<div class="empty-state"><div style="font-size: 64px; margin-bottom: 16px;">ğŸ“…</div><div>${emptyMsg}</div></div>`;
                return;
            }
            
            container.innerHTML = '';
            
            displayBookings.forEach(b => {
                const card = document.createElement('div');
                card.className = 'booking-card';
                if (b.assignmentSent && !b.assignmentAccepted) {
                    card.classList.add('new-assignment');
                }
                
                // ê³ ê°ëª…
                const name = document.createElement('div');
                name.className = 'customer-name';
                name.textContent = b.name;
                card.appendChild(name);
                
                // ì •ë³´ í–‰ë“¤
                const infoItems = [
                    { icon: 'ğŸ“…', text: b.serviceDate || 'ë¯¸ì§€ì •' },
                    { icon: 'ğŸ“', text: b.phone },
                    { icon: 'ğŸ“', text: b.address },
                    { icon: 'ğŸ ', text: b.service || b.items }
                ];
                
                infoItems.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'info-row';
                    row.innerHTML = `<div class="info-icon">${item.icon}</div><div class="info-value">${escapeHtml(item.text)}</div>`;
                    card.appendChild(row);
                });
                
                // í¬ë§ ì‹œê°„ëŒ€ í‘œì‹œ
                if (b.timeSlots && b.timeSlots.length > 0) {
                    const timeRow = document.createElement('div');
                    timeRow.style.cssText = 'background: #fff3cd; color: #856404; padding: 10px 12px; border-radius: 8px; margin-top: 10px; font-weight: 600; font-size: 15px;';
                    timeRow.innerHTML = 'ğŸ• í¬ë§: ' + escapeHtml(b.timeSlots.join(', '));
                    card.appendChild(timeRow);
                }
                
                // ìƒíƒœ ë°°ì§€
                const statusInfo = getStatusInfo(b.status);
                const badge = document.createElement('div');
                badge.className = 'status-badge';
                badge.style.background = statusInfo.color;
                badge.style.color = 'white';
                badge.textContent = statusInfo.text;
                card.appendChild(badge);
                
                // ì‹¤ì œ ì‹œì‘ ì‹œê°„ í‘œì‹œ
                if (b.actualStartTime) {
                    const timeInfo = document.createElement('div');
                    timeInfo.style.cssText = 'background: #e8f5e9; color: #2e7d32; padding: 10px 12px; border-radius: 8px; margin-top: 10px; font-weight: 700; font-size: 15px;';
                    timeInfo.textContent = 'âœ… ì‹œì‘: ' + b.actualStartTime;
                    card.appendChild(timeInfo);
                }
                
                // ì•¡ì…˜ ë²„íŠ¼
                const actions = document.createElement('div');
                actions.style.marginTop = '12px';
                
                if (b.status === 'confirmed') {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.style.cssText = 'background: #9b59b6; color: white;';
                    btn.textContent = 'ğŸ“… ìŠ¤ì¼€ì¤„ í”½ìŠ¤';
                    btn.onclick = (e) => { e.stopPropagation(); showTimePickerModal(b); };
                    actions.appendChild(btn);
                } else if (b.status === 'scheduled') {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn btn-start';
                    btn.textContent = 'ğŸš€ ì‘ì—…ì‹œì‘';
                    btn.onclick = (e) => { e.stopPropagation(); changeStatus(b.id, 'started'); };
                    actions.appendChild(btn);
                } else if (b.status === 'started') {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn btn-complete';
                    btn.textContent = 'âœ… ì‘ì—…ì™„ë£Œ';
                    btn.onclick = (e) => { e.stopPropagation(); changeStatus(b.id, 'completed'); };
                    actions.appendChild(btn);
                } else if (b.status === 'completed' || b.status === 'paid') {
                    const msg = document.createElement('div');
                    msg.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 8px; text-align: center; font-weight: 700;';
                    msg.textContent = b.status === 'paid' ? 'âœ… ì…ê¸ˆì™„ë£Œ!' : 'âœ… ì‘ì—…ì™„ë£Œ! (ì…ê¸ˆ ëŒ€ê¸°ì¤‘)';
                    card.appendChild(msg);
                }
                
                if (actions.childNodes.length > 0) {
                    card.appendChild(actions);
                }
                
                // ì „í™” & ì§€ë„ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
                const btnContainer = document.createElement('div');
                btnContainer.style.cssText = 'display: flex; gap: 8px; margin-top: 10px;';
                
                // ì „í™” ê±¸ê¸° ë²„íŠ¼
                const callBtn = document.createElement('a');
                callBtn.href = 'tel:' + b.phone;
                callBtn.style.cssText = 'flex: 1; padding: 12px; background: #00AEEF; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center; text-decoration: none;';
                callBtn.textContent = 'ğŸ“ ì „í™”';
                callBtn.onclick = (e) => e.stopPropagation();
                btnContainer.appendChild(callBtn);
                
                // ì§€ë„ ë³´ê¸° ë²„íŠ¼ (ì¹´ì¹´ì˜¤ë§µ)
                const mapBtn = document.createElement('a');
                const encodedAddr = encodeURIComponent(b.address || '');
                mapBtn.href = 'https://map.kakao.com/?q=' + encodedAddr;
                mapBtn.target = '_blank';
                mapBtn.style.cssText = 'flex: 1; padding: 12px; background: #FEE500; color: #3C1E1E; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center; text-decoration: none;';
                mapBtn.textContent = 'ğŸ—ºï¸ ì§€ë„';
                mapBtn.onclick = (e) => e.stopPropagation();
                btnContainer.appendChild(mapBtn);
                
                // ë„¤ì´ë²„ ì§€ë„ ë²„íŠ¼
                const naverBtn = document.createElement('a');
                naverBtn.href = 'https://map.naver.com/v5/search/' + encodedAddr;
                naverBtn.target = '_blank';
                naverBtn.style.cssText = 'flex: 1; padding: 12px; background: #03C75A; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center; text-decoration: none;';
                naverBtn.textContent = 'ğŸš— ë‚´ë¹„';
                naverBtn.onclick = (e) => e.stopPropagation();
                btnContainer.appendChild(naverBtn);
                
                card.appendChild(btnContainer);
                
                container.appendChild(card);
            });
        }
        
        // ========================================
        // ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜
        // ========================================
        function updateDateDisplay() {
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const d = currentDate;
            document.getElementById('currentDateDisplay').textContent = 
                `${d.getFullYear()}ë…„ ${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${days[d.getDay()]})`;
        }
        
        function prevDay() {
            currentDate.setDate(currentDate.getDate() - 1);
            updateDateDisplay();
            renderBookings();
        }
        
        function nextDay() {
            currentDate.setDate(currentDate.getDate() + 1);
            updateDateDisplay();
            renderBookings();
        }
        
        // ========================================
        // í•„í„°
        // ========================================
        function updateStats() {
            const todayStr = formatDate(new Date());
            const todayBookings = myBookings.filter(b => b.serviceDate === todayStr);
            const completedBookings = myBookings.filter(b => b.status === 'completed' || b.status === 'paid');
            
            document.getElementById('totalCount').textContent = myBookings.length;
            document.getElementById('todayCount').textContent = todayBookings.length;
            document.getElementById('completedCount').textContent = completedBookings.length;
        }
        
        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter' + filterMode.charAt(0).toUpperCase() + filterMode.slice(1)).classList.add('active');
        }
        
        function filterToday() {
            filterMode = 'today';
            currentDate = new Date();
            updateDateDisplay();
            updateFilterButtons();
            renderBookings();
        }
        
        function filterAll() {
            filterMode = 'all';
            updateFilterButtons();
            renderBookings();
        }
        
        function filterCompleted() {
            filterMode = 'completed';
            updateFilterButtons();
            renderBookings();
        }
        
        // ========================================
        // í”Œë ˆì´ìŠ¤í™€ë” í•¨ìˆ˜ë“¤
        // ========================================
        function showScheduleModal() {
            alert('ğŸ“… ìŠ¤ì¼€ì¤„ ë³´ê¸° ê¸°ëŠ¥\n\ní˜„ì¬ ' + myBookings.length + 'ê±´ì˜ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤.');
        }
        
        function showVacationModal() {
            alert('ğŸŒ´ íœ´ë¬´ ë“±ë¡ ê¸°ëŠ¥\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì—¬ íœ´ë¬´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.');
        }
        
        // ========================================
        // ì´ˆê¸°í™”
        // ========================================
        window.addEventListener('load', function() {
            
            
            // ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ í™•ì¸
            const saved = localStorage.getItem('currentManager');
            if (saved) {
                try {
                    currentManager = JSON.parse(saved);
                    
                    // ë¡œê·¸ì¸ ì‹œê°„ í™•ì¸ (24ì‹œê°„ ì´ˆê³¼ ì‹œ ì¬ë¡œê·¸ì¸)
                    const loginTime = new Date(currentManager.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        document.getElementById('loginContainer').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'block';
                        document.getElementById('driverName').textContent = currentManager.name;
                        
                        loadMyBookings();
                    } else {
                        // ì„¸ì…˜ ë§Œë£Œ
                        localStorage.removeItem('currentManager');
                        currentManager = null;
                    }
                } catch (e) {
                    localStorage.removeItem('currentManager');
                }
            }
            
            // â­ í´ë§ ê´€ë¦¬ (ë°±ê·¸ë¼ìš´ë“œ ì‹œ ì¤‘ì§€)
            let pollingInterval = null;
            
            function startPolling() {
                if (!pollingInterval) {
                    pollingInterval = setInterval(function() {
                        if (currentManager && document.getElementById('appContainer').style.display !== 'none') {
                            loadMyBookings();
                        }
                    }, 5000);
                }
            }
            
            function stopPolling() {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }
            
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopPolling();
                } else {
                    if (currentManager) loadMyBookings();
                    startPolling();
                }
            });
            
            startPolling();
        });
    </script>
</body>
</html>
